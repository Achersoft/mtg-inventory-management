<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.achersoft.user.persistence.UserMapper">
    <insert id="createUser">
        INSERT INTO user (user_name,
                          first_name,
                          last_name,
                          password) 
                  VALUES (#{username},
                          #{firstName},
                          #{lastName},
                          #{password})             
    </insert>

    <sql id="userSelection">
        SELECT u.id 'id', 
               u.user_name 'username', 
               u.user_first_name 'firstName', 
               u.user_last_name 'lastName', 
               u.locked 'locked',  
               u.login_attempt 'loginAttempts',  
               u.last_login 'lastAccessed'
          FROM user u
    </sql>
    
    <select id="getUser" resultType="com.achersoft.user.dao.User"> 
        <include refid="userSelection"/>
        WHERE u.id =  #{id}
    </select>
    
    <select id="getUserFromName" resultType="com.achersoft.user.dao.User"> 
        <include refid="userSelection"/>
        WHERE u.user_name =  #{userName}
    </select>
    
    <select id="getUserPrivileges" resultType="com.achersoft.security.type.Privilege"> 
        SELECT privilege 
          FROM user_privilege
         WHERE user_id = #{id}
    </select>
    
    <update id="editUser">
        UPDATE user SET
               user_name = #{username},
               user_first_name = #{firstName},
               user_last_name = #{lastName}, 
               <if test="password != null">
               password = #{password}, 
               </if>
               <if test="lastAccessed != null">
               last_login = #{lastAccessed}, 
               </if>
               <if test="loginAttempts != null">
               login_attempt = #{loginAttempts}, 
               </if>
               locked = #{locked}
         WHERE id = #{id}
    </update>  
    
    <insert id="addUserPrivileges">
        INSERT INTO persona_privilege (persona_id, 
                                       privilege) 
                               values
            <foreach item="element" index="index" collection="privileges" separator=",">
                                      (UNHEX(#{id}),
                                       #{element})
            </foreach>
    </insert>
    

    <delete id="deleteUser">
        DELETE 
          FROM user
         WHERE id = #{id}
    </delete>
    
    <select id="validateCredentials" resultType="boolean"> 
        SELECT CASE WHEN count(*) > 0 THEN 1 ELSE 0 END 
          FROM user u 
         WHERE u.login_id =  #{userId}
           AND u.password = #{password}
    </select> 
</mapper>